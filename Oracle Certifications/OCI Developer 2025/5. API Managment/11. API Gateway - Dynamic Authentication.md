In this lesson, we'll take a look at an important API Gateway feature designed to support multi-tenant architectures, in this case, dynamically selecting the authentication provider based on client information.

Before we dive in, let's review first a basic pattern used with API Gateway to enforce proper authentication and authorization of a client. In step 1, the client authenticates with an identity provider, such as OCI Identity and Access Management, Microsoft Active Directory, or Okta. If successfully authenticated, the client receives a token that provides authorization.

In step 2, the client invokes the API exposed by the gateway with that token. And in step 3, the API Gateway validates the token to ensure that the client is authorized to make the request. Now, if the client is authorized, the gateway routes to the appropriate backend service to fulfill the request and returns a response to the client.

Now, notice that in step 3, there is a trust relationship between the gateway and the identity provider. For the OCI API Gateway, this trust relationship is configured in the API deployment, which means each deployment has a specific single provider.

Now, for most use cases, this works well as all clients are provisioned using one identity provider per API deployment. However, how do you handle an API that needs to support multitenant clients where each tenant could have a separate identity provider?

Well, the answer is dynamic authentication where the gateway can choose the appropriate provider at runtime based on the client request. Here's how it works. The client authenticates with and receives a token from its chosen identity provider.

So just as before in step 2, it invokes the API using that token. What's different is that when the gateway receives the request with the token, it performs a lookup based on an element of the request to determine at runtime which identity provider to use.

Options include a request header, such as X-Tenant-ID, the host or subdomain that the client used to invoke the API, a path parameter, or even a claim in the authorization token. Then, of course, if authorization is successfully validated, the gateway routes the request to the backend and returns a response to the client.

Dynamic authentication also allows the API provider to choose how the token is validated for each tenant. Some tenants can use a JSON web token validation, and others can use an authorization function.

