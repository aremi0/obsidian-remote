La **Dynamic Authentication** in **OCI API Gateway** √® una funzionalit√† pensata per scenari **multi-tenant**, in cui ogni tenant pu√≤ avere un **Identity Provider (IdP)** diverso.  
Permette di **selezionare dinamicamente** l‚ÄôIdP corretto **a runtime**, in base a elementi della richiesta del client.

---

## üîÑ Flusso base di autenticazione (pattern standard)

1. **Autenticazione** ‚Äì Il client si autentica presso un IdP (es. OCI IAM, Microsoft AD, Okta) e ottiene un **token**.
2. **Invocazione API** ‚Äì Il client chiama l‚Äôendpoint del Gateway includendo il token.
3. **Validazione token** ‚Äì L‚ÄôAPI Gateway verifica il token con l‚ÄôIdP configurato (tramite certificati pubblici o introspection endpoint).
4. **Routing** ‚Äì Se autorizzato, il Gateway inoltra la richiesta al backend e restituisce la risposta.

> In configurazione standard, ogni **API Deployment** √® associato a **un solo IdP**.

---

## üè¢ Perch√© serve la Dynamic Authentication

In contesti **multi-tenant**, ogni tenant pu√≤ avere:

- Un IdP diverso
- Un metodo di validazione token differente (JWT vs Authorizer Function)

Con la Dynamic Authentication, **lo stesso API Deployment** pu√≤:

- Supportare pi√π IdP
- Scegliere **a runtime** quale usare, in base alla richiesta

---

## ‚öôÔ∏è Come funziona

1. Il client ottiene un token dal **proprio** IdP.
2. Invoca l‚ÄôAPI includendo il token.
3. Il Gateway **analizza un elemento della richiesta** per determinare quale IdP usare:
    - **Header** (es. `X-Tenant-ID`)
    - **Host** o **subdomain**
    - **Path parameter**
    - **Query parameter**
    - **Claim** nel token (`request.auth[<claim>]`)
4. Valida il token con l‚ÄôIdP selezionato.
5. Se valido, inoltra la richiesta al backend.

---

## üìå Context variables utilizzabili per la selezione

|Variabile|Descrizione|
|---|---|
|`request.headers["X-Tenant-ID"]`|Header personalizzato con ID tenant|
|`request.host`|Host della richiesta|
|`request.subdomain`|Parte iniziale del dominio|
|`request.path["param"]`|Parametro di path|
|`request.query["param"]`|Parametro di query|
|`request.auth["claim"]`|Claim JWT|

> Se una variabile ha pi√π valori, viene usato **solo il primo**.

---

## üõ† Tipi di autenticazione combinabili

- **JWT Authentication** ‚Üí validazione con IdP tramite certificati o introspection endpoint
- **Authorizer Function** ‚Üí funzione personalizzata per validare credenziali/token

√à possibile definire **pi√π authentication server** nello stesso deployment e creare **regole di selezione** basate sulle context variables.

---

## üìä Esempio di regola in API Deployment (JSON)

```json
"authenticationServers": [
  {
    "name": "TenantA-JWT",
    "type": "JWT_AUTHENTICATION",
    "selectionRule": "${request.headers['X-Tenant-ID']} == 'tenantA'"
  },
  {
    "name": "TenantB-Authorizer",
    "type": "CUSTOM_AUTHENTICATION",
    "selectionRule": "${request.subdomain} == 'tenantb'"
  }
]
```

---

## üîç Vantaggi

- **Scalabilit√†** ‚Üí un solo deployment per pi√π tenant
- **Flessibilit√†** ‚Üí metodi di autenticazione diversi per tenant
- **Manutenzione semplificata** ‚Üí meno duplicazione di configurazioni

---

## üìö Glossario

| Termine                     | Definizione chiara e contestualizzata                                                                                                |
| --------------------------- | ------------------------------------------------------------------------------------------------------------------------------------ |
| **Identity Provider (IdP)** | Sistema che autentica l‚Äôutente e rilascia il token (es. OCI IAM, Okta, Microsoft AD) utilizzato dall‚ÄôAPI Gateway per la validazione. |
| **API Deployment**          | Configurazione pubblicata del Gateway, comprensiva di rotte, backend, sicurezza e autenticazione.                                    |
| **Authentication Server**   | Componente configurato nel deployment che definisce come validare le credenziali (JWT o custom).                                     |
| **Selection Rule**          | Espressione che determina a runtime quale Authentication Server usare in base a variabili di contesto.                               |
| **Context Variables**       | Variabili come path, query, headers, host, subdomain, auth claims, utilizzabili per regole dinamiche.                                |
| **Claim**                   | Coppia chiave-valore all‚Äôinterno di un token (es. `iss`, `sub`, `aud`, `roles`) utilizzata per decisioni di accesso.                 |
| **Tenant**                  | Organizzazione/cliente servito da un‚ÄôAPI multi-tenant, con propria configurazione e IdP.                                             |
| **Multi-tenant**            | Architettura in cui pi√π tenant condividono lo stesso ambiente/API Gateway, con isolamento logico.                                    |

---
