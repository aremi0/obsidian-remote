La **Dynamic Routing** in **OCI API Gateway** consente di instradare richieste verso **backend diversi** in base a criteri dinamici, pur mantenendo unâ€™unica rotta esposta ai client.  
Ãˆ particolarmente utile per:

- **Multi-tenant** con backend dedicati per tenant
- **Versioning** di API
- **Instradamento per area geografica** o piano di utilizzo

---

## ğŸ”„ Flusso operativo

1. **Client Request** â€“ Il client invia una richiesta verso un endpoint del Gateway (es. `/sales`).
2. **Route Match** â€“ Il Gateway abbina la richiesta a una rotta definita nellâ€™API Deployment.
3. **Backend Selection** â€“ In base a un **selector** configurato, il Gateway sceglie **a runtime** quale backend usare.
4. **Forwarding** â€“ La richiesta viene inoltrata al backend selezionato e la risposta restituita al client.

---

## âš™ï¸ Elementi usabili come selector

Il **selector** Ã¨ unâ€™espressione che utilizza **context variables** per determinare il backend.  
Variabili supportate:

|Variabile|Descrizione|Esempio|
|---|---|---|
|`request.headers["X-Tenant-ID"]`|Header personalizzato|`tenantA` â†’ backend A|
|`request.query["region"]`|Parametro di query|`EU` â†’ backend europeo|
|`request.host`|Host della richiesta|`api.eu.example.com`|
|`request.subdomain`|Sottodominio|`tenantb.api.example.com`|
|`request.path["version"]`|Parametro di path|`v2` â†’ backend v2|
|`request.auth["claim"]`|Claim JWT|`plan=premium` â†’ backend premium|
|`request.usage_plan`|OCID del piano di utilizzo|Piano â€œGoldâ€ â†’ backend dedicato|

---

## ğŸ›  Esempio di configurazione

```json
"routes": [
  {
    "path": "/sales",
    "methods": ["GET"],
    "backends": [
      {
        "name": "Backend-EU",
        "url": "https://eu.example.com",
        "selectionRule": "${request.query['region']} == 'EU'"
      },
      {
        "name": "Backend-US",
        "url": "https://us.example.com",
        "selectionRule": "${request.query['region']} == 'US'"
      }
    ]
  }
]
```

---

## ğŸ¯ Vantaggi

- **Unica facciata** per piÃ¹ sistemi backend
- **Riduzione complessitÃ ** lato client
- **FlessibilitÃ ** nel routing senza modificare il codice client
- **ScalabilitÃ ** per scenari multi-tenant o multi-regione

---

## ğŸ“Š Schema visivo â€“ Dynamic Routing

```
[Client Request a /sales]
        â”‚
        â–¼
[Step 1: Route Match]
 â””â”€ Il Gateway abbina la richiesta alla rotta "/sales"
        â”‚
        â–¼
[Step 2: Backend Selection]
 â”œâ”€ Legge variabili di contesto:
 â”‚    â€¢ request.headers["X-Tenant-ID"]
 â”‚    â€¢ request.query["region"]
 â”‚    â€¢ request.host / request.subdomain
 â”‚    â€¢ request.path["version"]
 â”‚    â€¢ request.auth["claim"]
 â”‚    â€¢ request.usage_plan
 â”‚
 â”œâ”€ Applica selectionRule su ciascun backend candidato
 â”‚
 â”œâ”€ Esempio:
 â”‚    IF request.query["region"] == "EU" â†’ Backend-EU
 â”‚    IF request.query["region"] == "US" â†’ Backend-US
 â”‚    ELSE â†’ Backend-Default
        â”‚
        â–¼
[Step 3: Forwarding]
 â””â”€ Inoltra la richiesta al backend selezionato
        â”‚
        â–¼
[Step 4: Response]
 â””â”€ Restituisce la risposta al client
```

---

ğŸ“Œ In questo diagramma:

- **Blocchi** = step chiave del flusso
- **Liste** = variabili di contesto piÃ¹ comuni per il selector
- **Condizioni IF** = esempi concreti di regole di instradamento

---

## ğŸ“š Glossario

| Termine               | Definizione chiara e contestualizzata                                                                                  |
| --------------------- | ---------------------------------------------------------------------------------------------------------------------- |
| **Selector**          | Regola che determina quale backend usare, basata su context variables.                                                 |
| **Context Variables** | Variabili che rappresentano elementi della richiesta (path, query, headers, host, subdomain, auth claims, usage plan). |
| **Usage Plan**        | Piano di utilizzo associato a un client, usato anche per routing condizionale.                                         |
| **Multi-tenant**      | Architettura in cui piÃ¹ tenant condividono lo stesso deployment, con backend dedicati o condivisi.                     |

---
