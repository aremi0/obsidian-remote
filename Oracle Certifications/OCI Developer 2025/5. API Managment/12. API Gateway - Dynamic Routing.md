La **Dynamic Routing** in **OCI API Gateway** consente di instradare richieste verso **backend diversi** in base a criteri dinamici, pur mantenendo un’unica rotta esposta ai client.  
È particolarmente utile per:

- **Multi-tenant** con backend dedicati per tenant
- **Versioning** di API
- **Instradamento per area geografica** o piano di utilizzo

---

## 🔄 Flusso operativo

1. **Client Request** – Il client invia una richiesta verso un endpoint del Gateway (es. `/sales`).
2. **Route Match** – Il Gateway abbina la richiesta a una rotta definita nell’API Deployment.
3. **Backend Selection** – In base a un **selector** configurato, il Gateway sceglie **a runtime** quale backend usare.
4. **Forwarding** – La richiesta viene inoltrata al backend selezionato e la risposta restituita al client.

---

## ⚙️ Elementi usabili come selector

Il **selector** è un’espressione che utilizza **context variables** per determinare il backend.  
Variabili supportate:

|Variabile|Descrizione|Esempio|
|---|---|---|
|`request.headers["X-Tenant-ID"]`|Header personalizzato|`tenantA` → backend A|
|`request.query["region"]`|Parametro di query|`EU` → backend europeo|
|`request.host`|Host della richiesta|`api.eu.example.com`|
|`request.subdomain`|Sottodominio|`tenantb.api.example.com`|
|`request.path["version"]`|Parametro di path|`v2` → backend v2|
|`request.auth["claim"]`|Claim JWT|`plan=premium` → backend premium|
|`request.usage_plan`|OCID del piano di utilizzo|Piano “Gold” → backend dedicato|

---

## 🛠 Esempio di configurazione

```json
"routes": [
  {
    "path": "/sales",
    "methods": ["GET"],
    "backends": [
      {
        "name": "Backend-EU",
        "url": "https://eu.example.com",
        "selectionRule": "${request.query['region']} == 'EU'"
      },
      {
        "name": "Backend-US",
        "url": "https://us.example.com",
        "selectionRule": "${request.query['region']} == 'US'"
      }
    ]
  }
]
```

---

## 🎯 Vantaggi

- **Unica facciata** per più sistemi backend
- **Riduzione complessità** lato client
- **Flessibilità** nel routing senza modificare il codice client
- **Scalabilità** per scenari multi-tenant o multi-regione

---

## 📊 Schema visivo – Dynamic Routing

```
[Client Request a /sales]
        │
        ▼
[Step 1: Route Match]
 └─ Il Gateway abbina la richiesta alla rotta "/sales"
        │
        ▼
[Step 2: Backend Selection]
 ├─ Legge variabili di contesto:
 │    • request.headers["X-Tenant-ID"]
 │    • request.query["region"]
 │    • request.host / request.subdomain
 │    • request.path["version"]
 │    • request.auth["claim"]
 │    • request.usage_plan
 │
 ├─ Applica selectionRule su ciascun backend candidato
 │
 ├─ Esempio:
 │    IF request.query["region"] == "EU" → Backend-EU
 │    IF request.query["region"] == "US" → Backend-US
 │    ELSE → Backend-Default
        │
        ▼
[Step 3: Forwarding]
 └─ Inoltra la richiesta al backend selezionato
        │
        ▼
[Step 4: Response]
 └─ Restituisce la risposta al client
```

---

📌 In questo diagramma:

- **Blocchi** = step chiave del flusso
- **Liste** = variabili di contesto più comuni per il selector
- **Condizioni IF** = esempi concreti di regole di instradamento

---

## 📚 Glossario

| Termine               | Definizione chiara e contestualizzata                                                                                  |
| --------------------- | ---------------------------------------------------------------------------------------------------------------------- |
| **Selector**          | Regola che determina quale backend usare, basata su context variables.                                                 |
| **Context Variables** | Variabili che rappresentano elementi della richiesta (path, query, headers, host, subdomain, auth claims, usage plan). |
| **Usage Plan**        | Piano di utilizzo associato a un client, usato anche per routing condizionale.                                         |
| **Multi-tenant**      | Architettura in cui più tenant condividono lo stesso deployment, con backend dedicati o condivisi.                     |

---
